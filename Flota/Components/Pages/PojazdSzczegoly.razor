@page "/pojazdy/{Id:int}"
@using Flota.Domain.Entities
@using Flota.Domain.Interfaces
@inject IPojazdSerwis PojazdSerwis
@inject IUbezpieczenieSerwis UbezpieczenieSerwis
@inject ISerwisPojazdu SerwisPojazdu
@inject ITankowanieSerwis TankowanieSerwis
@inject IPrzydzialSerwis PrzydzialSerwis
@inject NavigationManager NavManager

@rendermode RenderMode.InteractiveServer

<div class="container mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Szczegóły pojazdu</h3>
        <button class="btn btn-outline-secondary" @onclick="Wroc">← Powrót</button>
    </div>

    @if (pojazd == null)
    {
        <div class="alert alert-info">Ładowanie danych pojazdu...</div>
    }
    else
    {
        <div class="card mb-4 shadow-sm border-primary">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">@pojazd.Marka @pojazd.Model</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <small class="text-muted">Rejestracja</small>
                        <div class="fs-5 fw-bold">@pojazd.NumerRejestracyjny</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Rok produkcji</small>
                        <div class="fs-5">@pojazd.RokProdukcji</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Aktualny Przebieg</small>
                        <div class="fs-5">@pojazd.Przebieg.ToString("N0") km</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Status</small>
                        <div>
                            <span class="badge @(pojazd.Status == Flota.Domain.Enums.StatusPojazdu.Dostepny ? "bg-success" : "bg-warning text-dark") fs-6">
                                @pojazd.Status
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">📜 Polisy Ubezpieczeniowe</h5>
                    </div>
                    <div class="card-body p-0">
                        @if (ubezpieczenia.Any())
                        {
                            <table class="table table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Polisa / Firma</th>
                                        <th>Ważność</th>
                                        <th>Akcja</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var u in ubezpieczenia)
                                    {
                                        var czyWygasa = (u.DataZakonczenia - DateTime.Now).TotalDays < 30;
                                        <tr class="@(czyWygasa ? "table-danger" : "")">
                                            <td>
                                                <strong>@u.NumerPolisy</strong><br/>
                                                <small>@u.Ubezpieczyciel</small>
                                            </td>
                                            <td>
                                                @u.DataRozpoczecia.ToShortDateString() - @u.DataZakonczenia.ToShortDateString()
                                                @if(czyWygasa) { <span class="badge bg-danger">Wygasa!</span> }
                                            </td>
                                            <td class="align-middle">
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => UsunPolise(u.Id)">X</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="p-3 text-muted text-center">Brak historii ubezpieczeń.</div>
                        }
                        
                        <div class="p-3 border-top bg-light">
                            <h6 class="text-muted mb-2">Dodaj nową polisę</h6>
                            <div class="row g-2">
                                <div class="col-4"><input class="form-control form-control-sm" placeholder="Nr Polisy" @bind="noweUbezpieczenie.NumerPolisy" /></div>
                                <div class="col-4"><input class="form-control form-control-sm" placeholder="Firma" @bind="noweUbezpieczenie.Ubezpieczyciel" /></div>
                                <div class="col-4"><input type="number" class="form-control form-control-sm" placeholder="Koszt" @bind="noweUbezpieczenie.Koszt" /></div>
                                <div class="col-6"><input type="date" class="form-control form-control-sm" @bind="noweUbezpieczenie.DataRozpoczecia" /></div>
                                <div class="col-6"><input type="date" class="form-control form-control-sm" @bind="noweUbezpieczenie.DataZakonczenia" /></div>
                                <div class="col-12 d-grid"><button class="btn btn-primary btn-sm" @onclick="DodajPolise">Zapisz Polisę</button></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">🛠️ Historia Napraw</h5>
                    </div>
                    <div class="card-body p-0">
                        @if (serwisy.Any())
                        {
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Opis</th>
                                        <th>Koszt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var s in serwisy)
                                    {
                                        <tr>
                                            <td>@s.DataZgloszenia.ToShortDateString()</td>
                                            <td>
                                                @s.Opis <br/>
                                                <span class="badge bg-secondary">@s.Status</span>
                                            </td>
                                            <td>@s.Koszt.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="p-3 text-muted text-center">Auto nie było jeszcze w serwisie.</div>
                        }
                    </div>
                </div>

            </div>

            <div class="col-lg-6">
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">⛽ Rejestr Tankowań</h5>
                    </div>
                    <div class="card-body p-0">
                         @if (tankowania.Any())
                        {
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Paliwo</th>
                                        <th>Koszt</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var t in tankowania)
                                    {
                                        <tr>
                                            <td>@t.Data.ToShortDateString()</td>
                                            <td>@t.IloscLitrow L</td>
                                            <td>@((t.IloscLitrow * t.CenaZaLitr).ToString("C"))</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="p-3 text-muted text-center">Brak zarejestrowanych tankowań.</div>
                        }
                    </div>
                </div>

                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">🔑 Historia Kierowców</h5>
                    </div>
                    <div class="card-body p-0">
                        @if (przydzialy.Any())
                        {
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Kierowca</th>
                                        <th>Wydano</th>
                                        <th>Zdano</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var p in przydzialy)
                                    {
                                        <tr>
                                            <td>
                                                @if(p.Kierowca != null) { @p.Kierowca.Imie @p.Kierowca.Nazwisko } 
                                                else { <span class="text-muted">Nieznany</span> }
                                            </td>
                                            <td>@p.DataRozpoczecia.ToShortDateString()</td>
                                            <td>
                                                @if(p.DataZakonczenia.HasValue) { @p.DataZakonczenia.Value.ToShortDateString() }
                                                else { <span class="badge bg-success">W trasie</span> }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="p-3 text-muted text-center">Auto nie było jeszcze przydzielone.</div>
                        }
                    </div>
                </div>

            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private Pojazd? pojazd;
    
    // Listy danych
    private List<Ubezpieczenie> ubezpieczenia = new();
    private List<WpisSerwisowy> serwisy = new();
    private List<Tankowanie> tankowania = new();
    private List<Przydzial> przydzialy = new();

    private Ubezpieczenie noweUbezpieczenie = new();

    protected override async Task OnInitializedAsync()
    {
        await ZaladujDane();
        
        noweUbezpieczenie.DataRozpoczecia = DateTime.Now;
        noweUbezpieczenie.DataZakonczenia = DateTime.Now.AddYears(1);
    }

    private async Task ZaladujDane()
    {
        // 1. Pobierz Pojazd
        var wszystkiePojazdy = await PojazdSerwis.PobierzWszystkieAsync();
        pojazd = wszystkiePojazdy.FirstOrDefault(p => p.Id == Id);

        // 2. Pobierz Ubezpieczenia (dedykowana metoda)
        ubezpieczenia = await UbezpieczenieSerwis.PobierzDlaPojazduAsync(Id);

        // 3. Pobierz i przefiltruj Historię Serwisową
        var allSerwisy = await SerwisPojazdu.PobierzWszystkieAsync();
        serwisy = allSerwisy.Where(s => s.PojazdId == Id).OrderByDescending(s => s.DataZgloszenia).ToList();

        // 4. Pobierz i przefiltruj Tankowania
        var allTankowania = await TankowanieSerwis.PobierzWszystkieAsync();
        tankowania = allTankowania.Where(t => t.PojazdId == Id).OrderByDescending(t => t.Data).ToList();

        // 5. Pobierz i przefiltruj Przydziały (Zarówno aktywne jak i historię)
        // Uwaga: Metoda PobierzHistorieAsync zwraca tylko zakończone, PobierzAktywneAsync tylko trwające.
        // Jeśli chcesz pełną historię, warto połączyć te listy lub dodać metodę w serwisie.
        // Na ten moment pobieramy historię (zakończone).
        var historyczne = await PrzydzialSerwis.PobierzHistorieAsync();
        var aktywne = await PrzydzialSerwis.PobierzAktywneAsync();
        
        przydzialy = historyczne
            .Concat(aktywne)
            .Where(p => p.PojazdId == Id)
            .OrderByDescending(p => p.DataRozpoczecia)
            .ToList();
    }

    private async Task DodajPolise()
    {
        noweUbezpieczenie.PojazdId = Id;
        await UbezpieczenieSerwis.DodajAsync(noweUbezpieczenie);
        await ZaladujDane();
        
        // Reset
        noweUbezpieczenie = new Ubezpieczenie 
        { 
            DataRozpoczecia = DateTime.Now, 
            DataZakonczenia = DateTime.Now.AddYears(1) 
        };
    }

    private async Task UsunPolise(int id)
    {
        await UbezpieczenieSerwis.UsunAsync(id);
        await ZaladujDane();
    }

    private void Wroc() => NavManager.NavigateTo("/pojazdy");
}