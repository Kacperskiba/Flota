@page "/serwis"
@using Flota.Domain.Entities
@using Flota.Domain.Interfaces
@inject ISerwisPojazduSerwis SerwisService
@inject IPojazdSerwis PojazdSerwis
@rendermode RenderMode.InteractiveServer

<div class="section-header">
    <h2 class="section-title">Centrum Serwisowe</h2>
</div>

<div class="form-container" style="margin-bottom: 32px;">
    <div class="form-header">
        <h2 class="form-title">Nowe Zgłoszenie</h2>
        <p class="form-subtitle">Dodanie zgłoszenia automatycznie zmieni status pojazdu na "W Serwisie"</p>
    </div>

    <EditForm Model="@noweZgloszenie" OnValidSubmit="DodajZgloszenie">
        <DataAnnotationsValidator />
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Wybierz Pojazd</label>
                <InputSelect @bind-Value="noweZgloszenie.PojazdId" class="form-input">
                    <option value="0">-- Wybierz --</option>
                    @if (listaPojazdow != null)
                    {
                        foreach (var p in listaPojazdow)
                        {
                            <option value="@p.Id">@p.Marka @p.Model (@p.NumerRejestracyjny)</option>
                        }
                    }
                </InputSelect>
            </div>
            <div class="form-group">
                <label class="form-label">Data Zgłoszenia</label>
                <InputDate @bind-Value="noweZgloszenie.DataZgloszenia" class="form-input" />
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Opis Problemu / Zakres Prac</label>
            <InputTextArea @bind-Value="noweZgloszenie.Opis" class="form-input" rows="3" />
            <ValidationMessage For="@(() => noweZgloszenie.Opis)" class="text-danger small"/>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Szacowany Koszt (PLN)</label>
                <InputNumber @bind-Value="noweZgloszenie.Koszt" class="form-input" />
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Utwórz Zgłoszenie</button>
        </div>
        
        @if (pokazSukces)
        {
            <div class="alert alert-success mt-3">Zgłoszenie dodane! Pojazd oznaczony jako W Serwisie.</div>
        }
    </EditForm>
</div>

<div class="data-table">
    <table class="table">
        <thead>
            <tr>
                <th>Pojazd</th>
                <th>Opis Usterki</th>
                <th>Data</th>
                <th>Koszt</th>
                <th>Zmień Status</th> </tr>
        </thead>
        <tbody>
            @if (zgloszenia == null) { <tr><td colspan="5">Ładowanie...</td></tr> }
            else
            {
                @foreach (var z in zgloszenia)
                {
                    // Stylizacja wiersza, jeśli zakończone to lekko szary
                    <tr style="@(z.Status == "Zakończone" ? "opacity: 0.6; background: #f9fafb;" : "")">
                        <td>
                            <strong>@z.Pojazd?.Marka</strong> <br/>
                            <small>@z.Pojazd?.NumerRejestracyjny</small>
                        </td>
                        <td>@z.Opis</td>
                        <td>@z.DataZgloszenia.ToShortDateString()</td>
                        <td>@z.Koszt.ToString("C")</td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    style="width: 140px; border-color: @KolorRamki(z.Status);"
                                    value="@z.Status" 
                                    @onchange="@(e => ZmienStatus(z.Id, e?.ToString()))">
                                <option value="W Trakcie">🛠️ W Trakcie</option>
                                <option value="Planowane">📅 Planowane</option>
                                <option value="Zakończone">✅ Zakończone</option>
                            </select>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<ZgloszenieSerwisowe>? zgloszenia;
    private List<Pojazd>? listaPojazdow;
    private ZgloszenieSerwisowe noweZgloszenie = new() { DataZgloszenia = DateTime.Now };
    private bool pokazSukces = false;

    protected override async Task OnInitializedAsync()
    {
        listaPojazdow = await PojazdSerwis.PobierzWszystkieAsync();
        await ZaladujZgloszenia();
    }

    private async Task ZaladujZgloszenia()
    {
        zgloszenia = await SerwisService.PobierzWszystkieAsync();
    }

    private async Task DodajZgloszenie()
    {
        if (noweZgloszenie.PojazdId == 0) return;

        await SerwisService.DodajAsync(noweZgloszenie);
        pokazSukces = true;
        noweZgloszenie = new() { DataZgloszenia = DateTime.Now };
        await ZaladujZgloszenia(); // Odświeżamy listę
        
        await Task.Delay(3000);
        pokazSukces = false;
        StateHasChanged();
    }

    private async Task ZmienStatus(int id, string? nowyStatus)
    {
        if (string.IsNullOrEmpty(nowyStatus)) return;
        
        await SerwisService.ZmienStatusAsync(id, nowyStatus);
        // Po zmianie statusu odświeżamy listę, żeby zaktualizować wygląd
        await ZaladujZgloszenia(); 
    }

    private string KolorRamki(string status) => status switch
    {
        "Zakończone" => "#10B981", // Zielony
        "W Trakcie" => "#F59E0B",  // Pomarańczowy
        _ => "#E5E7EB"             // Szary
    };
}