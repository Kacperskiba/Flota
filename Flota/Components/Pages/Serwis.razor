@page "/serwis"
@using Flota.Domain.Entities
@using Flota.Domain.Interfaces
@inject ISerwisPojazduSerwis SerwisService
@inject IPojazdSerwis PojazdSerwis
@inject IJSRuntime JS
@rendermode RenderMode.InteractiveServer

<div class="section-header">
    <h2 class="section-title">Centrum Serwisowe</h2>
</div>

<div class="form-container" style="margin-bottom: 32px;">
    <div class="form-header">
        <h2 class="form-title">Nowe Zgłoszenie</h2>
    </div>

    @if (!string.IsNullOrEmpty(blad))
    {
        <div class="alert alert-danger">
            ⚠️ @blad
        </div>
    }

    <EditForm Model="@noweZgloszenie" OnValidSubmit="DodajZgloszenie">
        <DataAnnotationsValidator />
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Wybierz Pojazd</label>
                <InputSelect @bind-Value="noweZgloszenie.PojazdId" class="form-input">
                    <option value="0">-- Wybierz --</option>
                    @if (listaPojazdow != null)
                    {
                        foreach (var p in listaPojazdow)
                        {
                            <option value="@p.Id">@p.Marka @p.Model (@p.NumerRejestracyjny)</option>
                        }
                    }
                </InputSelect>
            </div>
            
            <div class="form-group">
                <label class="form-label">Rodzaj Zgłoszenia</label>
                <InputSelect @bind-Value="noweZgloszenie.Status" class="form-input">
                    <option value="Planowane">Planowane</option>
                    <option value="W Trakcie">W Trakcie</option>
                </InputSelect>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Data Zgłoszenia</label>
                <InputDate @bind-Value="noweZgloszenie.DataZgloszenia" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label">Szacowany Koszt (PLN)</label>
                <InputNumber @bind-Value="noweZgloszenie.Koszt" class="form-input" />
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Opis Problemu / Zakres Prac</label>
            <InputTextArea @bind-Value="noweZgloszenie.Opis" class="form-input" rows="3" />
            <ValidationMessage For="@(() => noweZgloszenie.Opis)" class="text-danger small"/>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">Zapisz Zgłoszenie</button>
        </div>
        
        @if (pokazSukces)
        {
            <div class="alert alert-success mt-3">Zgłoszenie zostało zapisane!</div>
        }
    </EditForm>
</div>

<div class="data-table">
    <table class="table">
        <thead>
            <tr>
                <th>Pojazd</th>
                <th>Opis</th>
                <th>Data</th>
                <th>Status</th>
                <th>Akcja</th>
            </tr>
        </thead>
        <tbody>
            @if (zgloszenia == null) { <tr><td colspan="5">Ładowanie...</td></tr> }
            else
            {
                @foreach (var z in zgloszenia)
                {
                    <tr style="@(z.Status == "Zakończone" ? "opacity: 0.6; background: #f9fafb;" : "")">
                        <td>
                            <strong>@z.Pojazd?.Marka</strong> <br/>
                            <small>@z.Pojazd?.NumerRejestracyjny</small>
                        </td>
                        <td>@z.Opis</td>
                        <td>@z.DataZgloszenia.ToShortDateString()</td>
                        <td>
                            <span class="@KolorStatusu(z.Status)">@z.Status</span>
                        </td>
                        <td>
                            @if (z.Status != "Zakończone")
                            {
                                <button class="btn btn-success btn-sm" @onclick="() => ZakonczSerwis(z.Id)">✅ Zakończ</button>
                                @if (z.Status == "Planowane")
                                {
                                    <button class="btn btn-warning btn-sm ms-2" @onclick="() => RozpocznijSerwis(z.Id)">🛠️ Rozpocznij</button>
                                }
                            }
                            else
                            {
                                <span class="text-muted"><small>Zamknięte</small></span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<ZgloszenieSerwisowe>? zgloszenia;
    private List<Pojazd>? listaPojazdow;
    private ZgloszenieSerwisowe noweZgloszenie = new() { DataZgloszenia = DateTime.Now, Status = "Planowane" };
    private bool pokazSukces = false;
    private string blad = ""; // <--- ZMIENNA NA BŁĄD

    protected override async Task OnInitializedAsync()
    {
        listaPojazdow = await PojazdSerwis.PobierzWszystkieAsync();
        await ZaladujZgloszenia();
    }

    private async Task ZaladujZgloszenia()
    {
        zgloszenia = await SerwisService.PobierzWszystkieAsync();
    }

    private async Task DodajZgloszenie()
    {
        blad = ""; // Czyścimy stary błąd
        pokazSukces = false;

        if (noweZgloszenie.PojazdId == 0) 
        {
            blad = "Musisz wybrać pojazd!";
            return;
        }

        try
        {
            await SerwisService.DodajAsync(noweZgloszenie);
            
            // Sukces
            pokazSukces = true;
            noweZgloszenie = new() { DataZgloszenia = DateTime.Now, Status = "Planowane" };
            await ZaladujZgloszenia();
            
            await Task.Delay(3000);
            pokazSukces = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            // Łapiemy błąd z backendu (ten o zduplikowanym serwisie)
            blad = ex.Message;
        }
    }

    private async Task ZakonczSerwis(int id)
    {
        bool potwierdz = await JS.InvokeAsync<bool>("confirm", "Czy na pewno chcesz zakończyć ten serwis?");
        if (potwierdz)
        {
            await SerwisService.ZmienStatusAsync(id, "Zakończone");
            await ZaladujZgloszenia();
        }
    }

    private async Task RozpocznijSerwis(int id)
    {
        try 
        {
            await SerwisService.ZmienStatusAsync(id, "W Trakcie");
            await ZaladujZgloszenia();
        } 
        catch (Exception ex) 
        {
            // Wyświetlamy błąd z backendu (że auto jest zajęte) w wyskakującym okienku
            await JS.InvokeVoidAsync("alert", $"Błąd: {ex.Message}");
        }
    }

    private string KolorStatusu(string status) => status switch
    {
        "Zakończone" => "status-badge available",
        "W Trakcie" => "status-badge maintenance",
        "Planowane" => "status-badge in-service",
        _ => "status-badge"
    };
}