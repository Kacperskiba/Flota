@page "/pojazdy"
@using Flota.Domain.Entities
@using Flota.Domain.Enums
@using Flota.Domain.Interfaces
@inject IPojazdSerwis PojazdSerwis
@inject IJSRuntime JS
@inject NavigationManager NavManager 

@rendermode RenderMode.InteractiveServer

<div class="section-header">
    <h2 class="section-title">Zarządzanie Pojazdami</h2>
</div>

<div class="form-container" style="margin-bottom: 32px;">
    <div class="form-header">
        <h2 class="form-title">Dodaj Nowy Pojazd</h2>
        <p class="form-subtitle">Wprowadź dane techniczne pojazdu</p>
    </div>

    <EditForm Model="@nowyPojazd" OnValidSubmit="DodajPojazd">
        <DataAnnotationsValidator />
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Marka</label>
                <InputText @bind-Value="nowyPojazd.Marka" class="form-input" placeholder="np. Toyota" />
            </div>
            <div class="form-group">
                <label class="form-label">Model</label>
                <InputText @bind-Value="nowyPojazd.Model" class="form-input" placeholder="np. Corolla" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Nr Rejestracyjny</label>
                <InputText @bind-Value="nowyPojazd.NumerRejestracyjny" class="form-input" placeholder="DW 12345" />
            </div>
            <div class="form-group">
                <label class="form-label">Pojemność Baku (L)</label>
                <InputNumber @bind-Value="nowyPojazd.PojemnoscZbiornika" class="form-input" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Przebieg (km)</label>
                <InputNumber @bind-Value="nowyPojazd.Przebieg" class="form-input" />
            </div>
             <div class="form-group">
                 <label class="form-label">Rok Produkcji</label>
                 <InputNumber @bind-Value="nowyPojazd.RokProdukcji" class="form-input" />
             </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-primary">Dodaj Pojazd</button>
        </div>
    </EditForm>
</div>

<div class="data-table">
    <table class="table">
        <thead>
            <tr>
                <th>Pojazd</th>
                <th>Rejestracja</th>
                <th>Specyfikacja</th>
                <th>Status</th>
                <th>Akcje</th> 
            </tr>
        </thead>
        <tbody>
            @if (pojazdy == null) { <tr><td colspan="5">Ładowanie...</td></tr> }
            else
            {
                @foreach (var p in pojazdy)
                {
                    <tr>
                        <td><strong>@p.Marka @p.Model</strong> <br/> <small>Rok: @p.RokProdukcji</small></td>
                        <td>@p.NumerRejestracyjny</td>
                        <td>@p.Przebieg km</td>
                        <td>
                            <span class="@(p.Status == StatusPojazdu.Dostepny ? "status-badge available" : "status-badge in-service")">
                                @p.Status
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm" @onclick="() => PrzejdzDoSzczegolow(p.Id)" style="margin-right: 8px;">
                                Szczegóły
                            </button>

                            <button class="btn btn-danger btn-sm" @onclick="() => UsunPojazd(p.Id)">
                                Usuń
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<Pojazd>? pojazdy;
    private Pojazd nowyPojazd = new Pojazd();

    protected override async Task OnInitializedAsync()
    {
        await ZaladujPojazdy();
    }

    private async Task ZaladujPojazdy()
    {
        pojazdy = await PojazdSerwis.PobierzWszystkieAsync();
    }

    private async Task DodajPojazd()
    {
        nowyPojazd.Status = StatusPojazdu.Dostepny;
        await PojazdSerwis.DodajAsync(nowyPojazd);
        nowyPojazd = new Pojazd();
        await ZaladujPojazdy();
    }

    // Nowa metoda do obsługi kliknięcia przycisku
    private void PrzejdzDoSzczegolow(int id)
    {
        NavManager.NavigateTo($"/pojazdy/{id}");
    }

    private async Task UsunPojazd(int id)
    {
        bool potwierdzenie = await JS.InvokeAsync<bool>("confirm", "Czy na pewno chcesz usunąć ten pojazd? Tej operacji nie można cofnąć.");
        
        if (potwierdzenie)
        {
            await PojazdSerwis.UsunAsync(id);
            await ZaladujPojazdy();
        }
    }
}