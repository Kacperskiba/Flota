@page "/raporty"
@using Flota.Domain.Entities
@using Flota.Domain.Interfaces
@inject IPojazdSerwis PojazdSerwis
@inject ITankowanieSerwis TankowanieSerwis
@inject ISerwisPojazdu SerwisPojazdu

@rendermode RenderMode.InteractiveServer

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>📊 Raporty i Analityka</h2>
        <button class="btn btn-outline-primary" @onclick="ZaladujDane">🔄 Odśwież dane</button>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-primary">
                <div class="card-body text-center">
                    <small class="text-muted">Łączne Koszty Floty</small>
                    <h3 class="text-primary fw-bold">@LaczneKoszty.ToString("C0")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-success">
                <div class="card-body text-center">
                    <small class="text-muted">Wydatki na Paliwo</small>
                    <h3 class="text-success fw-bold">@KosztyPaliwa.ToString("C0")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-danger">
                <div class="card-body text-center">
                    <small class="text-muted">Wydatki na Serwis</small>
                    <h3 class="text-danger fw-bold">@KosztySerwisu.ToString("C0")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-warning">
                <div class="card-body text-center">
                    <small class="text-muted">Średni koszt na auto</small>
                    <h3 class="text-dark fw-bold">@SredniKosztNaAuto.ToString("C0")</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">🏆 Najdroższe pojazdy w utrzymaniu</h5>
                </div>
                <div class="card-body">
                    @if (RankingAut.Any())
                    {
                        @foreach (var r in RankingAut)
                        {
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold">@r.Marka @r.Model <small class="text-muted">(@r.Rejestracja)</small></span>
                                    <span>@r.SumaKosztow.ToString("C")</span>
                                </div>
                                @{
                                    var maxKoszt = RankingAut.First().SumaKosztow; // Najdroższe auto to 100% paska
                                    var procent = maxKoszt > 0 ? (r.SumaKosztow / maxKoszt) * 100 : 0;
                                }
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: @((int)procent)%"></div>
                                </div>
                                <small class="text-muted">
                                    Paliwo: @r.Paliwo.ToString("C0") | Serwis: @r.Serwis.ToString("C0")
                                </small>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center">Brak danych o kosztach.</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">🚗 Struktura Floty</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-muted">Statusy pojazdów</h6>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Dostępne</span>
                            <span class="text-success fw-bold">@IleDostepnych</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: @ObliczProcent(IleDostepnych)%"></div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-1">
                            <span>W Trasie (Wydane)</span>
                            <span class="text-warning fw-bold">@IleWTrasie</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-warning" style="width: @ObliczProcent(IleWTrasie)%"></div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between mb-1">
                            <span>W Serwisie</span>
                            <span class="text-danger fw-bold">@IleWSerwisie</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-danger" style="width: @ObliczProcent(IleWSerwisie)%"></div>
                        </div>
                    </div>
                    
                    <hr/>
                    <div class="text-center mt-3">
                        <h1>@LacznaLiczbaAut</h1>
                        <span class="text-muted">Wszystkich pojazdów</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Zmienne do statystyk
    private decimal LaczneKoszty = 0;
    private decimal KosztyPaliwa = 0;
    private decimal KosztySerwisu = 0;
    private decimal SredniKosztNaAuto = 0;

    private int LacznaLiczbaAut = 0;
    private int IleDostepnych = 0;
    private int IleWTrasie = 0;
    private int IleWSerwisie = 0;

    // Klasa pomocnicza do rankingu
    class AutoStatystyka
    {
        public string Marka { get; set; } = "";
        public string Model { get; set; } = "";
        public string Rejestracja { get; set; } = "";
        public decimal Paliwo { get; set; }
        public decimal Serwis { get; set; }
        public decimal SumaKosztow => Paliwo + Serwis;
    }

    private List<AutoStatystyka> RankingAut = new();

    protected override async Task OnInitializedAsync()
    {
        await ZaladujDane();
    }

    private async Task ZaladujDane()
    {
        // 1. Pobierz dane
        var pojazdy = await PojazdSerwis.PobierzWszystkieAsync();
        // Filtrujemy wyłączone, żeby nie psuły statystyk (chyba że chcesz historyczne)
        var aktywnePojazdy = pojazdy.Where(p => p.Status != Flota.Domain.Enums.StatusPojazdu.Wylaczony).ToList();

        var tankowania = await TankowanieSerwis.PobierzWszystkieAsync();
        var serwisy = await SerwisPojazdu.PobierzWszystkieAsync();

        // 2. Oblicz Statusy
        LacznaLiczbaAut = aktywnePojazdy.Count;
        IleDostepnych = aktywnePojazdy.Count(p => p.Status == Flota.Domain.Enums.StatusPojazdu.Dostepny);
        IleWTrasie = aktywnePojazdy.Count(p => p.Status == Flota.Domain.Enums.StatusPojazdu.WUzytkowaniu);
        IleWSerwisie = aktywnePojazdy.Count(p => p.Status == Flota.Domain.Enums.StatusPojazdu.WSerwisie);

        // 3. Oblicz Koszty Globalne
        KosztyPaliwa = tankowania.Sum(t => t.LacznyKoszt);
        KosztySerwisu = serwisy.Sum(s => s.Koszt); // Upewnij się czy pole to 'Koszt' czy 'KosztNaprawy'
        LaczneKoszty = KosztyPaliwa + KosztySerwisu;
        
        if (LacznaLiczbaAut > 0)
            SredniKosztNaAuto = LaczneKoszty / LacznaLiczbaAut;
        else
            SredniKosztNaAuto = 0;

        // 4. Buduj Ranking Aut
        RankingAut = new List<AutoStatystyka>();
        
        foreach (var p in aktywnePojazdy)
        {
            var kosztPaliwaAuta = tankowania.Where(t => t.PojazdId == p.Id).Sum(t => t.LacznyKoszt);
            var kosztSerwisuAuta = serwisy.Where(s => s.PojazdId == p.Id).Sum(s => s.Koszt);

            RankingAut.Add(new AutoStatystyka
            {
                Marka = p.Marka,
                Model = p.Model,
                Rejestracja = p.NumerRejestracyjny,
                Paliwo = kosztPaliwaAuta,
                Serwis = kosztSerwisuAuta
            });
        }

        // Sortuj malejąco po sumie kosztów i weź TOP 5
        RankingAut = RankingAut.OrderByDescending(x => x.SumaKosztow).Take(5).ToList();
    }

    private double ObliczProcent(int wartosc)
    {
        if (LacznaLiczbaAut == 0) return 0;
        return ((double)wartosc / LacznaLiczbaAut) * 100;
    }
}